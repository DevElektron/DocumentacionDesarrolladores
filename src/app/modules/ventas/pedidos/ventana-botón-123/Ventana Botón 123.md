# üì¶ M√≥dulo: Ventana Bot√≥n 123
#### üìÅ **C√≥digo:** `src/app/modules/ventas/pedidos/components/pedido-detalle-tiempos-traspasos`
#### üíª **Men√∫:** Men√∫ > > >  [Ver en QA](http://192.168.2.16:1089/app/ventas/pedidos)
#### üíª **Men√∫:** Men√∫ > > >  [Ver en QA](http://192.168.2.16:1089/app/ventas/pedidos)

## üìù Descripci√≥n

Cuando en la ruta de `/app/ventas/pedidos` se carga los detalles de las partidas de un pedido con backorders (que no se tiene el stock del art√≠culo disponible en almacenes), se habilita el bot√≥n 123 que est√° en la parte superior-derecha para abrir un ventana que muestra los detalles de los tiempos de los traspasos de la partida (registros DALMTAT). La ventana muestra los siguientes bloques:

1. **Registros DALMTAT:** Tabla que muestra los registros de los detalles de pedido por `FOLIO - PARTIDA` que muestra las fechas (tiempos) de los traspasos.
2. **Total de Cantidad de registros DALMTAT:** Suma de la columna `Cantidad` de la tabla anterior.
3. **Registros de Backorders de art√≠culo:** Tabla que muestra los datos de backorders asociados al `almac√©n de destino - art√≠culo`, obtenidos a partir de la informaci√≥n del registro DALMTAT que no tiene dato en la columna `N√∫mero`, con un icono de sem√°foro del estado del backorder respecto a la cantidad objetivo (total de registros DALMTAT) y el acumulado:

    - üü¢ **Verde:** Acumulado suficiente o excedente: acumulado >= 0. La cantidad acumulada cubre completamente la necesidad; no hay riesgo de incumplimiento.
    - üü° **Amarillo:** Cobertura parcial: acumulado < 0 pero a√∫n mayor que cantidad negativa del backorder. Hay d√©ficit, pero la partida actual contribuye a reducirlo; se est√° cerca de cubrir la necesidad.
    - üî¥ **Rojo:** D√©ficit cr√≠tico: acumulado <= cantidad negativa del backorder. La cantidad acumulada m√°s la partida actual no alcanza a cubrir la necesidad; riesgo alto de incumplimiento.

4. **Total de Cantidad de registros Backorders:** Suma de la columna `Cantidad` de la tabla anterior.
5. **Informaci√≥n de Manifiestos:** Muestra los manifiestos asociado al `Folio de Traspasos` del registro DALMTAT seleccionado.
6. **Fecha Mayor y Reprogramado:** Muestra la fecha en la que tiene la tentativa de entrega / recepci√≥n por parte del pedido, con una leyenda que indica si fue reprogramada manualmente o no.
7. **Datos del art√≠culo:** Clave y Descripci√≥n del art√≠culo asociado a `FOLIO - PARTIDA` de la ventana.

La ventana del bot√≥n 123 tiene 3 botones en la parte superior derecha:

1. **Actualizar:** Refresca la informaci√≥n de la ventana.
2. **Nuevo detalle:** Abre un formulario para establecer un nuevo registro DALMTAT con la Fecha de Recepci√≥n especificada.
3. **Modificar detalle:** Abre un formulario para modifica el registro DALMTAT seleccionado con la Fecha de Recepci√≥n especificada.

## üîê Seguridad

Por motivos de que es una funcionalidad secundaria de la ruta `/app/ventas/pedidos`, cualquier rol/usuario que tenga acceso a la ruta mencionada podr√° ver y usar esta caracter√≠stica.

## üíº Pol√≠ticas Generales

1. En cuanto a la activaci√≥n del bot√≥n 123, se mostrar√° un mensaje al hacer clic en √©l si el pedido _no est√° autorizado por cuestiones de cr√©dito_, es decir:
    - Si **NO est√° autorizado** el pedido.
    - Si el pedido es de tipo **No-Stock**.
2. La carga de la ventana que se abre con el bot√≥n 123 ser√° bloqueada si no hay registros relacionados con los detalles de los tiempos de los traspasos de la partida, busc√°ndolos en la informaci√≥n guardada por el `FOLIO - PARTIDA` del detalle del pedido. 

V√©ase [Seguridad](#üîê-seguridad).

## üß™ Casos de Prueba

### 1. Activaci√≥n y Desactivaci√≥n del bot√≥n 123

#### üíº Operaci√≥n

- [ ] 1. Haz clic en `Ventas/Pedidos`.
- [ ] 2. Busca un pedido con backorders con el control `SELECT` que aparece en la parte superior central de la ventana, seleccionando `Backorders`, y/o usando los filtros de la tabla de pedidos, por ejemplo: _Folio D09 - 431185_.
- [ ] 3. En los detalle cargados en la tabla de `Detalle de Partidas del Pedido` (debajo a la izquierda de la tabla de pedidos), selecciona una Partida que tenga backorders (columna Backorders > 0), en ese momento el bot√≥n 123 se debe de mostrar _habilitado_ para hacer clic.
- [ ] 4. Si seleccionas una partida sin backorders, el bot√≥n 123 estar√° _desactivado_.

#### üõ°Ô∏è Validaciones

- [ ] Boton 123 habilitado si se selecciona partida con backorders.
- [ ] Boton 123 deshabilitado si se selecciona partida sin backorders.

### 2. Carga bloqueda de la ventana bot√≥n 123

#### üíº Operaci√≥n

- [ ] 1. Cuando el bot√≥n 123 est√© habilitado con partidas que cumplan con una de las 2 siguientes condiciones, **NO** se deber√° de cargar la ventana del bot√≥n 123:

    - Si **NO est√° autorizado** el pedido y es de tipo **No-Stock**.
    - Si no se encuentran los registros de informaci√≥n de tiempo de entrega de traspasos.

Para esta prueba, comprueba buscando los siguientes pedidos y las partidas especificadas:

1. Partida sin registros de informaci√≥n de tiempo de entrega de traspasos:

    - FOLIO PEDIDO = A - 424581
    - PARTIDA = 1

2. Partida sin autorizaci√≥n:

    - FOLIO PEDIDO = D11 - 414064
    - PARTIDA = 1

#### üõ°Ô∏è Validaciones

- [ ] Partida sin registros al dar clic en bot√≥n 123 se muestra mensaje: 'No se logr√≥ localizar ning√∫n registro: No se logr√≥ encontrar algun traspaso u orden de compra para surtir este backorder (Folio = A - 414064, Partida = 1).'.
- [ ] Partida sin autorizaci√≥n al dar clic en bot√≥n 123 se muestra mensaje: 'Imposible Mostrar Datos: Pedido NO Autorizado por Cr√©dito'.

### 3. Carga de la ventana bot√≥n 123

#### üíº Operaci√≥n

- [ ] 1. Cuando el bot√≥n 123 est√© habilitado con partidas que tengan backorders y sin ninguna de los 2 detalles mencionados en la prueba 2, se cargar√° la ventana del bot√≥n 123 con los elementos descritos en [Descripci√≥n](#üìù-descripci√≥n). Algunos datos notables:

    1. No todas las partidas que cargan la ventana tendr√°n informaci√≥n en la tablas de backorders y manifiestos.
    2. La leyenda _SIN FECHA_ en el apartado de Fecha Mayor / Reprogramado es com√∫n para las partidas que no han tenido tratamiento en alg√∫n tiempo.

#### üõ°Ô∏è Validaciones

- [ ] Carga sin errores de la ventana del bot√≥n 123.

### 4. Muestra de informaci√≥n de manifiesto del registros DALMTAT seleccionado

#### üíº Operaci√≥n

- [ ] En una partida de pedido que tenga registros DALMTAT, selecciona uno y te mostrar√° en la tabla de abajo los detalles de la informaci√≥n de los manifiestos.

> NOTA: Son muy escasos los ejemplos de ventana bot√≥n 123 con manifiestos.

#### üõ°Ô∏è Validaciones

- [ ] Al seleccionar un registros de la tabla DALMTAT se visualiza la informaci√≥n de manifiestos.

### 5. Uso del bot√≥n `Actualizar`

#### üíº Operaci√≥n

- [ ] Hacer clic en el bot√≥n `Actualizar` (dejar el cursor un segundo encima del bot√≥n para ver el nombre del bot√≥n), para que carguen nuevamente todos los bloques de la ventana.

> NOTA: Como no vuelve a traer muchos datos no se notar√° alg√∫n cambio, recomendado seleccionar filas de las tablas para que observes el reseteo de la informaci√≥n.

#### üõ°Ô∏è Validaciones

- [ ] Actualizaci√≥n de la informaci√≥n cargada en  la ventana.

### 5. Uso del bot√≥n `Nuevo detalle`

#### üíº Operaci√≥n

- [ ] 1. Hacer clic en el bot√≥n `Nuevo detalle` (dejar el cursor un segundo encima del bot√≥n para ver el nombre del bot√≥n), se te mostrar√° un formulario con los siguientes campos:

    1. No editables:
        - Folio del Pedido.
        - Partida cargada.
        - Consecutivo (n√∫mero de captura manual).
        - Clave del Art√≠culo.
    2. Editable:
        - Fecha de Entrega.

- [ ] 2. Selecciona una fecha de entrega en el bot√≥n del calendario (derecha del campo) menor al d√≠a de hoy, se te mostrar√° una validaci√≥n: 'Debe ser mayor o igual a hoy.'.
- [ ] 3. Selecciona una fecha de entrega mayor igual a la de hoy y da clic en `Guardar`, se te pedir√° confirmar la acci√≥n, conf√≠rmala y se cerrar√° en autom√°tico el formulario, y tu nuevo registro estar√° en la tabla de registros DALMTAT.

#### üõ°Ô∏è Validaciones

- [ ] Validaci√≥n 'Debe ser mayor o igual a hoy.' mostrada.
- [ ] Validaci√≥n 'Debe seleccionar una Fecha de Entrega.' mostrada.
- [ ] Nuevo registro con fecha de entrega especificada en el formulario mostrada en tabla registros DALMTAT.

### 6. Uso del bot√≥n `Modificar detalle`

#### üíº Operaci√≥n

- [ ] 1. Hacer clic en el bot√≥n `Modificar detalle` (dejar el cursor un segundo encima del bot√≥n para ver el nombre del bot√≥n), se te mostrar√° un formulario con los siguientes campos:

    1. No editables:
        - Folio del Pedido.
        - Partida cargada.
        - Consecutivo (n√∫mero de captura manual).
        - Clave del Art√≠culo.
    2. Editable:
        - Fecha de Entrega (_precargada con la fecha de entrega del registro seleccionado_).

- [ ] 2. Selecciona una fecha de entrega en el bot√≥n del calendario (derecha del campo) menor al d√≠a de hoy, se te mostrar√° una validaci√≥n: 'Debe ser mayor o igual a hoy.'.
- [ ] 3. Selecciona una fecha de entrega mayor igual a la de hoy y da clic en `Guardar`, se te pedir√° confirmar la acci√≥n, conf√≠rmala y se cerrar√° en autom√°tico el formulario, y tu nuevo registro estar√° en la tabla de registros DALMTAT.

#### üõ°Ô∏è Validaciones

- [ ] Validaci√≥n 'Debe ser mayor o igual a hoy.' mostrada.
- [ ] Validaci√≥n 'Debe seleccionar una Fecha de Entrega.' mostrada.
- [ ] Nuevo registro con fecha de entrega especificada en el formulario mostrada en tabla registros DALMTAT.

### 7. Fecha Mayor y Reprogramaci√≥n Manual

#### üíº Operaci√≥n

- [ ] Cualquier interacci√≥n confirmada con los bot√≥n `Nuevo detalle` y `Modificar detalle` para agregar/actualizar registros DALMTAT se hace el c√°lculo de la leyenda ubicada en la parte superior `FECHA DE ENTREGA APROXIMADA:`, compuesta por 2 partes:

    1. Fecha Mayor: Fecha aproximada de entrega de la partida del pedido.
    2. Reyprogramaci√≥n: Ver si se ha hecho una reprogramaci√≥n de esa fecha por captura manual.

> NOTA: Debes de prestar atenci√≥n a los totales de cantidades en las tablas de registros DALMTAT y Backorders, ya que si el total de registros DALMTAT _ES MENOR AL TOTAL_ de Backorders, no se mostrar√° la fecha mayor y s√≥lo se mostrar√° la leyenda _'SIN FECHA'_. Cuando es tiene una partida con un n√∫mero de orden registrado, es altamente probable que se muestren cambios en este bloque.

#### üõ°Ô∏è Validaciones

- [ ] Con la especificaci√≥n contenida en `NOTA`, cualquier cambio de la `FECHA DE ENTREGA APROXIMADA:`.

## üìé Observaciones adicionales

1. Se agreg√≥ al Microservicio del Gateway el m√©todo `PATCH` para no tener que depender de las caracter√≠sticas del m√©todo `PUT` del HttpClientService.
2. Hay campos/columnas de tipo Fecha/Hora que que calculan en tiempo de ejecuci√≥n, como la √∫ltima columna de la tabla de Manifiestos `Transcurrido`, cuyo c√°lculo toma la informaci√≥n de la configuraci√≥n del Sistema Operativo en el que se ejecuta el proyecto. El timezone correcto es `America/Mexico_City`, ya que si est√° otro (por ejemplo `UTC` que es muy com√∫n en SO Linux), verificalo con el equipo si observas un comportamiento de diferencia dentre los resultados del ERP ElektronSQL basado en Clarion y el proyecto.

> üóìÔ∏è **Fecha de √∫ltima modificaci√≥n:** 2025-09-09
> üë§ **Sergio Tostado**
> üè∑Ô∏è **Versi√≥n:** 1

---
# Comunicaciones
|Dir|Fecha       |Firma|Comentario                    |
|---|------------|-----|------------------------------|
